!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).packet={})}(this,(function(e){"use strict";function t(e,t,i,n){return new(i||(i=Promise))((function(r,o){function a(e){try{u(n.next(e))}catch(e){o(e)}}function s(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,s)}u((n=n.apply(e,t||[])).next())}))}function i(e,t){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var n="undefined"!=typeof window&&void 0!==window.document,r=function(){if(n)return function(e){return t(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,fetch(e)];case 1:return[4,t.sent().json()];case 2:return[2,t.sent()]}}))}))};var e=require("fs");return function(n){return t(this,void 0,void 0,(function(){return i(this,(function(t){return[2,new Promise((function(t,i){e.readFile(n,{encoding:"utf-8"},(function(e,n){null!=e&&i(e),t(JSON.parse(n))}))}))]}))}))}}(),o=Object.freeze({__proto__:null}),a=/(?:Array<)*(?:(\w+)Enum)*\.*(\w+)>*/;function s(e,t,i){var n=a.exec(e.__type);if(null==n)throw new Error("Error at field '"+e.__identifier+"' entity '"+i+"': Invalid type name "+e.__type);var r=e.__type.startsWith("Array"),o=null!=n[1],s=e.__identifier,u=n[2],l=u;o&&(u="Enum"),r&&(u+="Array");var f=e.__value;null!=f&&"Point"===u&&(f={x:f.cx,y:f.cy}),"PointArray"===u&&(f=f.map((function(e){return{x:e.cx,y:e.cy}})));var d={id:s,type:u,value:f};return o&&(d.ref=t.enumMap[l]),d}var u=function(){function e(e,t,i){this.world=e,this.data=t,this.pxOffset=i,this.fields={};for(var n=0;n<t.fieldInstances.length;++n){var r=t.fieldInstances[n];this.fields[r.__identifier]=s(r,e,this.id)}var o=e.data.defs.entities;if(null!=o)for(n=0;n<o.length;++n)if(o[n].uid===this.data.defUid){var a=o[n].tilesetId;null!=a&&(this.tileset_=e.tilesetMap[a])}}return Object.defineProperty(e.prototype,"gridPos",{get:function(){return{x:this.data.__grid[0],y:this.data.__grid[1]}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.data.__identifier},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pivot",{get:function(){return{x:this.data.__pivot[0],y:this.data.__pivot[1]}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tile",{get:function(){return this.data.__tile},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tileset",{get:function(){return this.tileset_},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pos",{get:function(){return{x:this.data.px[0]+this.pxOffset.x,y:this.data.px[1]+this.pxOffset.y}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"relativePos",{get:function(){return{x:this.data.px[0],y:this.data.px[1]}},enumerable:!1,configurable:!0}),e}(),l=function(){function e(e,t){switch(this.world=e,this.data=t,this.autoLayerTiles_=null,this.entities_=null,this.gridTiles_=null,this.intGrid_=null,this.intGridValues={},null!=this.data.__tilesetDefUid&&(this.tileset_=this.world.findTilesetByUid(this.data.__tilesetDefUid)),this.type){case"AutoLayer":this.autoLayerTiles_=t.autoLayerTiles;break;case"Entities":this.entities_=new Array(t.entityInstances.length);for(var i=0;i<t.entityInstances.length;++i){var n=t.entityInstances[i];this.entities_[i]=new u(e,n,this.pxTotalOffset)}break;case"Tiles":this.gridTiles_=t.gridTiles;break;case"IntGrid":this.intGrid_=new Array(this.size.width);for(i=0;i<t.intGrid.length;++i){n=t.intGrid[i];var r=Math.floor(n.coordId/this.size.width),o=n.coordId-r*this.size.width;null==this.intGrid_[o]&&(this.intGrid_[o]=new Array(this.size.height)),this.intGrid_[o][r]=n.v}var a=e.data.defs.layers;if(null!=a)for(i=0;i<a.length;++i)if(a[i].uid===this.uid)for(var s=0;s<a[i].intGridValues.length;++s)this.intGridValues[s]={color:a[i].intGridValues[s].color,id:a[i].intGridValues[s].identifier}}}return Object.defineProperty(e.prototype,"size",{get:function(){return{width:this.data.__cWid,height:this.data.__cHei}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gridSize",{get:function(){return this.data.__gridSize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"opacity",{get:function(){return this.data.__opacity},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pxTotalOffset",{get:function(){return{x:this.data.__pxTotalOffsetX,y:this.data.__pxTotalOffsetY}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"type",{get:function(){return this.data.__type},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"autoLayerTiles",{get:function(){return this.autoLayerTiles_},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"entities",{get:function(){return this.entities_},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gridTiles",{get:function(){return this.gridTiles_},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"intGrid",{get:function(){return this.intGrid_},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"level",{get:function(){return this.world.findLevelByUid(this.data.levelId)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tileset",{get:function(){return this.tileset_},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uid",{get:function(){return this.data.layerDefUid},enumerable:!1,configurable:!0}),e}(),f=function(){function e(e){this.data=e}return Object.defineProperty(e.prototype,"color",{get:function(){return this.data.__bgColor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pos",{get:function(){return this.data.__bgPos},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pivot",{get:function(){return{x:this.data.bgPivotX,y:this.data.bgPivotY}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this.data.bgRelPath},enumerable:!1,configurable:!0}),e}(),d=function(){function e(e,t){if(this.world=e,this.data=t,this.layers=[],this.neighbours_=null,this.background=new f(t),null!=this.data.layerInstances)for(var i=0;i<this.data.layerInstances.length;++i)this.layers[i]=new l(e,this.data.layerInstances[i])}return Object.defineProperty(e.prototype,"id",{get:function(){return this.data.identifier},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return{width:this.data.pxWid,height:this.data.pxHei}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uid",{get:function(){return this.data.uid},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pos",{get:function(){return{x:this.data.worldX,y:this.data.worldY}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"neighbours",{get:function(){if(null==this.neighbours_){this.neighbours_=[];for(var e=0;e<this.data.__neighbours.length;++e){var t=this.world.findLevelByUid(this.data.__neighbours[e].levelUid);if(null==t)throw new Error("Neighbour '"+this.data.__neighbours[e].levelUid+"' for level '"+this.data.identifier+"' does not exist.");this.neighbours[e]={dir:this.data.__neighbours[e].dir,level:t}}}return this.neighbours_},enumerable:!1,configurable:!0}),e}(),c=function(){function e(e,t){var i;this.world=e,this.data=t,this.tileset=null,this.valueMap={};for(var n=0;n<t.values.length;++n){var r=t.values[n];this.valueMap[r.id]={id:r.id,tileSrcRect:{x:r.__tileSrcRect[0],y:r.__tileSrcRect[1],width:r.__tileSrcRect[2],height:r.__tileSrcRect[3]}}}this.valueIds=Object.keys(this.valueMap),this.values=Object.values(this.valueMap),null!=this.data.iconTilesetUid&&(this.tileset=null!==(i=e.findTilesetByUid(this.data.iconTilesetUid))&&void 0!==i?i:null)}return Object.defineProperty(e.prototype,"id",{get:function(){return this.data.identifier},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uid",{get:function(){return this.data.uid},enumerable:!1,configurable:!0}),e}(),h=function(){function e(e,t){this.world=e,this.data=t}return Object.defineProperty(e.prototype,"id",{get:function(){return this.data.identifier},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"padding",{get:function(){return this.data.padding},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return{width:this.data.pxWid,height:this.data.pxHei}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this.data.relPath},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"spacing",{get:function(){return this.data.spacing},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gridSize",{get:function(){return this.data.tileGridSize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uid",{get:function(){return this.data.uid},enumerable:!1,configurable:!0}),e}(),p=function(){function e(e){this.data=e,this.tilesetMap={},this.tilesetIds=[],this.tilesets=[],this.enumMap={},this.enumIds=[],this.enums=[];for(var t=0;t<e.defs.tilesets.length;++t){var i=e.defs.tilesets[t];this.tilesetMap[i.identifier]=new h(this,i)}this.tilesetIds=Object.keys(this.tilesetMap),this.tilesets=Object.values(this.tilesetMap);for(t=0;t<e.defs.enums.length;++t){var n=e.defs.enums[t];this.enumMap[n.identifier]=new c(this,n)}if(this.enumIds=Object.keys(this.enumMap),this.enums=Object.values(this.enumMap),this.levelMap={},this.levelIds=[],this.levels=[],!e.externalLevels){for(t=0;t<e.levels.length;++t)this.levelMap[e.levels[t].identifier]=new d(this,e.levels[t]);this.levelIds=Object.keys(this.levelMap),this.levels=Object.values(this.levelMap)}}return e.prototype.findLevel=function(e){for(var t=0;t<this.levels.length;++t)if(e(this.levels[t]))return this.levels[t]},e.prototype.findTileset=function(e){for(var t=0;t<this.tilesets.length;++t)if(e(this.tilesets[t]))return this.tilesets[t]},e.prototype.findEnum=function(e){for(var t=0;t<this.enums.length;++t)if(e(this.enums[t]))return this.enums[t]},e.prototype.findLevelByUid=function(e){return this.findLevel((function(t){return t.uid===e}))},e.prototype.findTilesetByUid=function(e){return this.findTileset((function(t){return t.uid===e}))},e.prototype.findTilesetByPath=function(e){return this.findTileset((function(t){return t.path===e}))},e.prototype.findEnumByUid=function(e){return this.findEnum((function(t){return t.uid===e}))},Object.defineProperty(e.prototype,"externalLevels",{get:function(){return this.data.externalLevels},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bgColor",{get:function(){return this.data.bgColor},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"layout",{get:function(){return this.data.worldLayout},enumerable:!1,configurable:!0}),e.prototype.loadLevels=function(){return t(this,void 0,void 0,(function(){var e,t,n,r,o,a=this;return i(this,(function(i){switch(i.label){case 0:for(e=[],t=this.data.levels,n=function(i){var n=t[i];if(null!=r.levelMap[n.identifier])return"continue";var o=n.externalRelPath;null!=o&&e.push(r.fetchLevel(o).then((function(e){a.levelMap[e.id]=e,a.levelIds[i]=e.id,a.levels[i]=e})))},r=this,o=0;o<t.length;++o)n(o);return[4,Promise.all(e)];case 1:return i.sent(),[2]}}))}))},e.prototype.loadLevel=function(e){return t(this,void 0,void 0,(function(){var t,n,r,o;return i(this,(function(i){switch(i.label){case 0:if(null!=this.levelMap[e])return[2];for(t=-1,n=null,r=0;r<this.data.levels.length;++r)if(this.data.levels[r].identifier===e){n=this.data.levels[r],t=r;break}if(null==n)throw new Error("Level "+e+" does not exist!");return[4,this.fetchLevel(n.externalRelPath)];case 1:return o=i.sent(),this.levelMap[o.id]=o,this.levelIds[t]=o.id,this.levels[t]=o,[2]}}))}))},e.fromJSON=function(t){return new e(t)},e.fromURL=function(n){return t(this,void 0,void 0,(function(){var t;return i(this,(function(i){switch(i.label){case 0:return t=e.bind,[4,r(n)];case 1:return[2,new(t.apply(e,[void 0,i.sent()]))]}}))}))},e.prototype.fetchLevel=function(e){return t(this,void 0,void 0,(function(){var t,n;return i(this,(function(i){switch(i.label){case 0:return t=d.bind,n=[void 0,this],[4,r(e)];case 1:return[2,new(t.apply(d,n.concat([i.sent()])))]}}))}))},e.loadRaw=function(e){return t(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,r(e)];case 1:return[2,t.sent()]}}))}))},e}();e.Background=f,e.Entity=u,e.Enum=c,e.LDtk=o,e.Layer=l,e.Level=d,e.Tileset=h,e.World=p,Object.defineProperty(e,"__esModule",{value:!0})}));
